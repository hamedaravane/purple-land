var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);import{r as i,g as s}from"./phaser-CKN4kaq3.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver((e=>{for(const i of e)if("childList"===i.type)for(const e of i.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)})).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var h=i();const r=s(h);class o extends r.GameObjects.Container{constructor(e,i,s,h,r,o){super(e,s,i),t(this,"q"),t(this,"r"),t(this,"x"),t(this,"y"),t(this,"bubble"),t(this,"tileGraphics"),t(this,"size"),this.q=i,this.r=s,this.x=h,this.y=r,this.size=o,this.bubble=null,this.tileGraphics=e.add.graphics({x:this.x,y:this.y}),this.drawTile(),this.setupInteractivity(e)}drawTile(){this.tileGraphics.clear(),this.tileGraphics.lineStyle(1,13421772,1),this.tileGraphics.beginPath(),o.getHexPoints(this.size).forEach(((e,t)=>{0===t?this.tileGraphics.moveTo(e.x,e.y):this.tileGraphics.lineTo(e.x,e.y)})),this.tileGraphics.closePath(),this.tileGraphics.strokePath()}static getHexPoints(e){const t=[];for(let i=0;i<6;i++){const s=60*i-30,h=r.Math.DegToRad(s);t.push(new r.Geom.Point(e*Math.cos(h),e*Math.sin(h)))}return t}placeBubble(e){this.bubble?console.warn(`Tile (${this.q}, ${this.r}) is already occupied.`):(this.bubble=e,e.setPosition(this.x,this.y))}removeBubble(){this.bubble&&(this.bubble=null)}isEmpty(){return null===this.bubble}getNeighbors(e){return[{dq:1,dr:0},{dq:1,dr:-1},{dq:0,dr:-1},{dq:-1,dr:0},{dq:-1,dr:1},{dq:0,dr:1}].map((t=>e.getTile(this.r+t.dr,this.q+t.dq))).filter((e=>void 0!==e))}setupInteractivity(e){this.tileGraphics.setInteractive(o.getHexPoints(this.size).map((e=>({x:e.x,y:e.y}))),r.Geom.Polygon.Contains),this.tileGraphics.on("pointerdown",(()=>{this.bubble&&(this.removeBubble(),e.events.emit("bubblePopped",this))})),this.tileGraphics.on("pointerover",(()=>{this.tileGraphics.lineStyle(2,65280,1),this.tileGraphics.strokePath()})),this.tileGraphics.on("pointerout",(()=>{this.tileGraphics.lineStyle(1,13421772,1),this.tileGraphics.strokePath()}))}}class a{constructor(e,i,s){t(this,"tiles",[]),t(this,"scene"),t(this,"numCols"),t(this,"numRows"),t(this,"size"),t(this,"hexWidth"),t(this,"hexHeight"),t(this,"hSpacing"),t(this,"vSpacing"),this.scene=e,this.numCols=i,this.numRows=s,this.size=this.calculateHexSize(),this.hexWidth=Math.sqrt(3)*this.size,this.hexHeight=2*this.size,this.hSpacing=this.hexWidth,this.vSpacing=1.5*this.size,this.tiles=[],this.createGrid(),this.scene.scale.on("resize",this.onResize,this)}calculateHexSize(){return this.scene.scale.width/this.numCols/Math.sqrt(3)}createGrid(){const e=this.calculateGridStartY(),t=this.scene.scale.width/2,i=this.calculateMaxColumns();for(let s=0;s<this.numRows;s++){const h=this.getHexesInRow(i),r=this.calculateTotalRowWidth(h),a=this.calculateGridStartX(t,r),n=this.getRowOffset(s),l=[];for(let t=0;t<h;t++){const i=this.calculateHexXPosition(a,t,n),h=this.calculateHexYPosition(e,s),r=new o(this.scene,t,s,i,h,this.size);l.push(r)}this.tiles.push(l)}}calculateGridStartY(){const e=(this.numRows-1)*this.vSpacing+this.hexHeight;return(this.scene.scale.height-e)/2}getHexesInRow(e){return e}calculateTotalRowWidth(e){return e<=0?0:(e-1)*this.hSpacing+this.hexWidth}calculateGridStartX(e,t){return e-t/2}getRowOffset(e){return e%2!=0?this.hSpacing/2:0}calculateHexXPosition(e,t,i){return e+t*this.hSpacing+i}calculateHexYPosition(e,t){return e+t*this.vSpacing}calculateMaxColumns(){const e=.9*this.scene.scale.width,t=Math.floor((e-this.hexWidth)/this.hSpacing+1);return Math.min(this.numCols,t)}onResize(){this.destroyGrid(),this.createGrid()}destroyGrid(){for(const e of this.tiles)for(const t of e)t.destroy();this.tiles=[]}getTile(e,t){if(e<0||e>=this.tiles.length)return;const i=this.tiles[e];return t<0||t>=i.length?void 0:i[t]}placeBubbleNear(e,t,i){let s=null,h=1/0;for(const r of this.tiles)for(const i of r)if(i.isEmpty()){const r=Phaser.Math.Distance.Between(e,t,i.x,i.y);r<h&&(h=r,s=i)}return s?(s.placeBubble(i),!0):(console.warn("No empty tile found near the target position."),!1)}findConnectedBubbles(e,t,i,s=new Set){var h;const r=this.getTile(e,t);if(!r||(null==(h=r.bubble)?void 0:h.color)!==i||s.has(`${e},${t}`))return[];s.add(`${e},${t}`);let o=[r];return r.getNeighbors(this).forEach((e=>{o=o.concat(this.findConnectedBubbles(e.r,e.q,i,s))})),o}checkForMatches(){const e=[],t=new Set;this.tiles.forEach((i=>{i.forEach((i=>{if(i.bubble&&!t.has(`${i.r},${i.q}`)){const s=this.findConnectedBubbles(i.r,i.q,i.bubble.color,t);s.length>=3&&e.push(s)}}))})),e.forEach((e=>{e.forEach((e=>{e.removeBubble()}))}))}}class n{constructor(e,i){var s,h;t(this,"scene"),t(this,"shooterX"),t(this,"shooterY"),t(this,"aimerGraphics"),t(this,"lineLength"),t(this,"angle"),t(this,"isCharging",!1),t(this,"chargeStartTime",0),t(this,"maxChargeTime"),t(this,"chargeMultiplier"),t(this,"bubblePreview"),t(this,"minAngle"),t(this,"maxAngle"),t(this,"boundUpdateAngle"),t(this,"boundStartCharging"),t(this,"boundReleaseCharge"),this.scene=e,this.shooterX=i.shooterX,this.shooterY=i.shooterY,this.lineLength=i.lineLength??100,this.maxChargeTime=i.maxChargeTime??2e3,this.chargeMultiplier=i.chargeMultiplier??2,this.minAngle=(null==(s=i.angleConstraints)?void 0:s.min)??r.Math.DegToRad(-75),this.maxAngle=(null==(h=i.angleConstraints)?void 0:h.max)??r.Math.DegToRad(75),this.angle=r.Math.Clamp(-r.Math.DegToRad(90),this.minAngle,this.maxAngle),this.aimerGraphics=this.scene.add.graphics(),this.aimerGraphics.setPosition(this.shooterX,this.shooterY),this.aimerGraphics.setDepth(1);const o=i.bubblePreviewKey??"bubble_preview";this.scene.textures.exists(o)?(this.bubblePreview=this.scene.add.sprite(0,0,o),this.bubblePreview.setAlpha(.5),this.bubblePreview.setScale(.5),this.bubblePreview.setDepth(0),this.bubblePreview.setVisible(!0)):console.warn(`Texture "${o}" not found. Bubble preview will not be displayed.`),this.drawAimer(),this.boundUpdateAngle=this.updateAngle.bind(this),this.boundStartCharging=this.startCharging.bind(this),this.boundReleaseCharge=this.releaseCharge.bind(this),this.scene.input.on("pointermove",this.boundUpdateAngle),this.scene.input.on("pointerdown",this.boundStartCharging),this.scene.input.on("pointerup",this.boundReleaseCharge)}drawAimer(){this.aimerGraphics.clear(),this.aimerGraphics.lineStyle(2,16711680,1),this.aimerGraphics.beginPath();const e=this.lineLength*Math.cos(this.angle),t=this.lineLength*Math.sin(this.angle);this.aimerGraphics.moveTo(0,0),this.aimerGraphics.lineTo(e,t),this.aimerGraphics.strokePath(),this.aimerGraphics.closePath(),this.bubblePreview&&this.bubblePreview.visible&&this.bubblePreview.setPosition(e,t)}updateAngle(e){if(this.isCharging)return;const t=this.scene.input.activePointer,i=t.worldX-this.shooterX,s=t.worldY-this.shooterY;let h=Math.atan2(s,i);h=r.Math.Clamp(h,this.minAngle,this.maxAngle),r.Math.Angle.Wrap(this.angle)!==r.Math.Angle.Wrap(h)&&(this.angle=h,this.drawAimer())}startCharging(e){this.isCharging||(this.isCharging=!0,this.chargeStartTime=this.scene.time.now,this.aimerGraphics.lineStyle(2,65280,1),this.drawAimer())}releaseCharge(e){if(!this.isCharging)return;this.isCharging=!1;const t=this.scene.time.now-this.chargeStartTime,i=r.Math.Clamp(t/this.maxChargeTime,0,1)*this.chargeMultiplier;this.aimerGraphics.lineStyle(2,16711680,1),this.drawAimer(),this.scene.events.emit("shootBubble",{direction:this.getDirection(),charge:i})}getDirection(){return new r.Math.Vector2(Math.cos(this.angle),Math.sin(this.angle)).normalize()}updateShooterPosition(e,t){this.shooterX=e,this.shooterY=t,this.aimerGraphics.setPosition(this.shooterX,this.shooterY),this.drawAimer()}destroy(){this.aimerGraphics.destroy(),this.bubblePreview&&this.bubblePreview.destroy(),this.scene.input.off("pointermove",this.boundUpdateAngle),this.scene.input.off("pointerdown",this.boundStartCharging),this.scene.input.off("pointerup",this.boundReleaseCharge)}}class l extends r.Physics.Arcade.Sprite{constructor(e,i,s,h,r){super(e,i,s,h),t(this,"color"),this.color=r,e.add.existing(this),e.physics.add.existing(this),this.body.setCircle(this.width/2),this.body.setImmovable(!0)}pop(){this.scene.add.tween({targets:this,scale:0,alpha:0,duration:300,ease:"Power2",onComplete:()=>{this.destroy()}})}}class c extends r.Scene{constructor(){super({key:"BubbleShooterScene"}),t(this,"hexGrid"),t(this,"staticBubbleGroup"),t(this,"movingBubbleGroup"),t(this,"aimer"),t(this,"shooterX"),t(this,"shooterY"),t(this,"shooterSprite"),t(this,"collideCallback",((e,t)=>{if(e===t)return;const i=e;i.body.setVelocity(0,0),i.body.enable=!1,this.placeBubbleAtBubblePosition(i)}))}preload(){this.load.image("shooter","assets/shooter.png"),this.load.image("bubble_preview","assets/bubble_preview.png"),this.load.image("bubble_red","assets/bubble_red.png"),this.load.image("bubble_blue","assets/bubble_blue.png"),this.load.image("bubble_green","assets/bubble_green.png")}create(){this.hexGrid=new a(this,12,5),this.staticBubbleGroup=this.physics.add.staticGroup(),this.movingBubbleGroup=this.physics.add.group({collideWorldBounds:!0,bounceX:1,bounceY:1}),[{row:5,col:5,color:"red"},{row:5,col:6,color:"blue"},{row:6,col:5,color:"green"}].forEach((e=>{const t=this.hexGrid.getTile(e.row,e.col);if(t&&t.isEmpty()){const i=new l(this,t.x,t.y,`bubble_${e.color}`,e.color);t.placeBubble(i),this.staticBubbleGroup.add(i)}})),this.shooterX=this.cameras.main.width/2,this.shooterY=this.cameras.main.height-50,this.shooterSprite=this.add.sprite(this.shooterX,this.shooterY,"shooter"),this.shooterSprite.setDepth(1),this.shooterSprite.setName("shooter"),this.aimer=new n(this,{shooterX:this.shooterX,shooterY:this.shooterY,lineLength:150,maxChargeTime:3e3,chargeMultiplier:3,bubblePreviewKey:"bubble_preview",angleConstraints:{min:r.Math.DegToRad(-75),max:r.Math.DegToRad(75)}}),this.events.on("shootBubble",this.handleShootBubble,this),this.events.on("bubblePopped",this.hexGrid.checkForMatches,this),this.scale.on("resize",this.onResize,this)}handleShootBubble(e){var t;const{direction:i,charge:s}=e,h=this.getRandomColor(),r=new l(this,this.shooterX,this.shooterY,`bubble_${h}`,h);this.movingBubbleGroup.add(r);const o=500*s;this.physics.velocityFromRotation(i.angle(),o,r.body.velocity),r.setCollideWorldBounds(!0),r.body.onWorldBounds=!0,null==(t=r.body)||t.world.on("worldbounds",(e=>{e.gameObject===r&&this.placeBubbleAtBubblePosition(r)})),this.physics.add.overlap(this.movingBubbleGroup,this.staticBubbleGroup,this.collideCallback,void 0,this)}placeBubbleAtBubblePosition(e){this.hexGrid.placeBubbleNear(e.x,e.y,e)?(this.movingBubbleGroup.remove(e,!0,!1),this.staticBubbleGroup.add(e),this.hexGrid.checkForMatches()):e.destroy()}getRandomColor(){const e=["red","blue","green"];return e[r.Math.Between(0,e.length-1)]}onResize(e,t,i,s){this.shooterX=e.width/2,this.shooterY=e.height-50;const h=this.children.getByName("shooter");h&&h.setPosition(this.shooterX,this.shooterY),this.aimer&&this.aimer.updateShooterPosition(this.shooterX,this.shooterY)}shutdown(){this.aimer&&this.aimer.destroy(),this.events.off("shootBubble",this.handleShootBubble,this),this.events.off("bubblePopped",this.hexGrid.checkForMatches,this),this.staticBubbleGroup&&this.staticBubbleGroup.destroy(!0,!0),this.movingBubbleGroup&&this.movingBubbleGroup.destroy(!0,!0),this.scale.off("resize",this.onResize,this),super.shutdown()}update(){}}const b={type:Phaser.AUTO,width:600,height:800,parent:"game-container",backgroundColor:"transparent",scale:{mode:Phaser.Scale.EXPAND,autoCenter:Phaser.Scale.CENTER_BOTH},scene:[c],physics:{default:"arcade",arcade:{gravity:{x:0,y:0}}}};new h.Game(b);
